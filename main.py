from abc import ABC, abstractmethod
from datetime import datetime


class Cliente:
    """Classe que representa um cliente do banco."""

    def __init__(self, endereco: str) -> None:
        self.endereco: str = endereco
        self.contas: list[Conta] = []

    def realizar_transacao(self, conta: "Conta", transacao: "Transacao") -> None:
        """Realiza uma transa√ß√£o em uma conta espec√≠fica."""
        if len(conta.historico.transacoes) >= 10:
            print("‚ùå Erro: Limite de 10 transa√ß√µes por dia atingido!")
            return

        transacao.registrar(conta)

    def adicionar_conta(self, conta: "Conta") -> None:
        """Adiciona uma conta √† lista de contas do cliente."""
        self.contas.append(conta)


class PessoaFisica(Cliente):
    """Classe que representa uma pessoa f√≠sica como cliente do banco."""

    def __init__(self, nome: str, data_nascimento: str, cpf: str, endereco: str) -> None:
        super().__init__(endereco)
        self.nome: str = nome
        self.data_nascimento: str = data_nascimento
        self.cpf: str = self._formatar_cpf(cpf)

    def _formatar_cpf(self, cpf: str) -> str:
        """Remove formata√ß√£o do CPF e armazena apenas n√∫meros."""
        return "".join(filter(str.isdigit, cpf))

    def get_cpf_formatado(self) -> str:
        """Retorna CPF formatado para exibi√ß√£o."""
        cpf = self.cpf
        return f"{cpf[:3]}.{cpf[3:6]}.{cpf[6:9]}-{cpf[9:]}"

    def __str__(self) -> str:
        return f"{self.nome} - CPF: {self.get_cpf_formatado()}"


class Conta:
    """Classe base que representa uma conta banc√°ria."""

    _contador_contas: int = 1

    def __init__(self, cliente: Cliente, numero: int | None = None) -> None:
        self._saldo_centavos: int = 0
        self._numero: int = numero if numero else Conta._contador_contas
        self._agencia: str = "0001"
        self._cliente: Cliente = cliente
        self._historico: Historico = Historico()

        if numero is None:
            Conta._contador_contas += 1

    @classmethod
    def nova_conta(cls, cliente: Cliente, numero: int) -> "Conta":
        """M√©todo de classe para criar uma nova conta."""
        return cls(cliente, numero)

    @property
    def saldo(self) -> float:
        """Retorna o saldo em reais."""
        return self._saldo_centavos / 100

    @property
    def numero(self) -> int:
        """Retorna o n√∫mero da conta."""
        return self._numero

    @property
    def agencia(self) -> str:
        """Retorna a ag√™ncia."""
        return self._agencia

    @property
    def cliente(self) -> Cliente:
        """Retorna o cliente."""
        return self._cliente

    @property
    def historico(self) -> "Historico":
        """Retorna o hist√≥rico."""
        return self._historico

    def sacar(self, valor: float) -> bool:
        """Realiza saque da conta."""
        if valor <= 0:
            print("‚ùå Erro: O valor do saque deve ser positivo!")
            return False

        valor_centavos = int(valor * 100)

        if valor_centavos > self._saldo_centavos:
            print("‚ùå Erro: Saldo insuficiente para realizar o saque!")
            print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
            return False

        self._saldo_centavos -= valor_centavos
        print("‚úÖ Saque realizado com sucesso!")
        print(f"üí∏ Valor sacado: {self._formatar_moeda(valor_centavos)}")
        print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
        return True

    def depositar(self, valor: float) -> bool:
        """Realiza dep√≥sito na conta."""
        if valor <= 0:
            print("‚ùå Erro: O valor do dep√≥sito deve ser positivo!")
            return False

        valor_centavos = int(valor * 100)
        self._saldo_centavos += valor_centavos

        print("‚úÖ Dep√≥sito realizado com sucesso!")
        print(f"üí∞ Valor depositado: {self._formatar_moeda(valor_centavos)}")
        print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
        return True

    def _formatar_moeda(self, centavos: int) -> str:
        """Formata centavos para exibi√ß√£o em moeda brasileira."""
        reais = centavos // 100
        cents = centavos % 100
        return f"R$ {reais}.{cents:02d}"

    def get_saldo_formatado(self) -> str:
        """Retorna o saldo atual formatado."""
        return self._formatar_moeda(self._saldo_centavos)


class ContaCorrente(Conta):
    """Classe que representa uma conta corrente com limites espec√≠ficos."""

    def __init__(
        self, cliente: Cliente, numero: int | None = None, limite: float = 500.0, limite_saques: int = 3
    ) -> None:
        super().__init__(cliente, numero)
        self._limite_centavos: int = int(limite * 100)
        self._limite_saques: int = limite_saques
        self._saques_realizados_hoje: int = 0
        self._data_ultimo_saque: str = ""

    def sacar(self, valor: float) -> bool:
        """Realiza saque com valida√ß√µes espec√≠ficas da conta corrente."""
        if valor <= 0:
            print("‚ùå Erro: O valor do saque deve ser positivo!")
            return False

        valor_centavos = int(valor * 100)
        data_hoje = datetime.now().strftime("%d/%m/%Y")

        # Reset contador se mudou o dia
        if self._data_ultimo_saque != data_hoje:
            self._saques_realizados_hoje = 0
            self._data_ultimo_saque = data_hoje

        # Valida√ß√£o de limite de saques di√°rios
        if self._saques_realizados_hoje >= self._limite_saques:
            print(f"‚ùå Erro: Limite de {self._limite_saques} saques di√°rios atingido!")
            return False

        # Valida√ß√£o de limite por saque
        if valor_centavos > self._limite_centavos:
            print(f"‚ùå Erro: Valor excede o limite m√°ximo de {self._formatar_moeda(self._limite_centavos)} por saque!")
            return False

        # Valida√ß√£o de saldo
        if valor_centavos > self._saldo_centavos:
            print("‚ùå Erro: Saldo insuficiente para realizar o saque!")
            print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
            return False

        # Realiza o saque
        self._saldo_centavos -= valor_centavos
        self._saques_realizados_hoje += 1

        print("‚úÖ Saque realizado com sucesso!")
        print(f"üí∏ Valor sacado: {self._formatar_moeda(valor_centavos)}")
        print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
        print(f"üìä Saques restantes hoje: {self._limite_saques - self._saques_realizados_hoje}")
        return True

    def __str__(self) -> str:
        return f"""\
            Ag√™ncia:\t{self.agencia}
            C/C:\t\t{self.numero}
            Titular:\t{self.cliente.nome if isinstance(self.cliente, PessoaFisica) else 'Cliente'}
        """


class Historico:
    """Classe que representa o hist√≥rico de transa√ß√µes de uma conta."""

    def __init__(self) -> None:
        self._transacoes: list[Transacao] = []

    @property
    def transacoes(self) -> list["Transacao"]:
        """Retorna a lista de transa√ß√µes."""
        return self._transacoes

    def adicionar_transacao(self, transacao: "Transacao") -> None:
        """Adiciona uma transa√ß√£o ao hist√≥rico."""
        self._transacoes.append(transacao)

    def gerar_relatorio(self, tipo_transacao: str | None = None) -> str:
        """Gera relat√≥rio das transa√ß√µes."""
        if not self._transacoes:
            return "üìù Nenhuma movimenta√ß√£o registrada."

        relatorio = []
        for transacao in self._transacoes:
            if tipo_transacao is None or transacao.__class__.__name__.lower() == tipo_transacao.lower():
                relatorio.append(
                    f"{transacao.data_hora.strftime('%d/%m/%Y %H:%M:%S')} - "
                    f"{transacao.__class__.__name__}: R$ {transacao.valor:.2f}"
                )

        return "\n".join(relatorio) if relatorio else f"üìù Nenhuma transa√ß√£o do tipo '{tipo_transacao}' encontrada."

    def transacoes_do_dia(self) -> list["Transacao"]:
        """Retorna transa√ß√µes do dia atual."""
        hoje = datetime.now().date()
        return [t for t in self._transacoes if t.data_hora.date() == hoje]


class Transacao(ABC):
    """Classe abstrata base para transa√ß√µes."""

    def __init__(self, valor: float) -> None:
        self._valor: float = valor
        self.data_hora: datetime = datetime.now()

    @property
    def valor(self) -> float:
        """Valor da transa√ß√£o."""
        return self._valor

    @abstractmethod
    def registrar(self, conta: Conta) -> None:
        """Registra a transa√ß√£o na conta."""
        pass


class Saque(Transacao):
    """Classe que representa uma transa√ß√£o de saque."""

    def __init__(self, valor: float) -> None:
        super().__init__(valor)

    def registrar(self, conta: Conta) -> None:
        """Registra o saque na conta."""
        sucesso = conta.sacar(self.valor)
        if sucesso:
            conta.historico.adicionar_transacao(self)


class Deposito(Transacao):
    """Classe que representa uma transa√ß√£o de dep√≥sito."""

    def __init__(self, valor: float) -> None:
        super().__init__(valor)

    def registrar(self, conta: Conta) -> None:
        """Registra o dep√≥sito na conta."""
        sucesso = conta.depositar(self.valor)
        if sucesso:
            conta.historico.adicionar_transacao(self)


def exibir_menu() -> None:
    """Exibe o menu principal do sistema."""
    print("\n" + "=" * 60)
    print("üè¶ SISTEMA BANC√ÅRIO - VERS√ÉO 3.0 (CLASSES)")
    print("=" * 60)
    print("1Ô∏è‚É£  Criar Usu√°rio")
    print("2Ô∏è‚É£  Criar Conta Corrente")
    print("3Ô∏è‚É£  Depositar")
    print("4Ô∏è‚É£  Sacar")
    print("5Ô∏è‚É£  Visualizar Extrato")
    print("6Ô∏è‚É£  Listar Usu√°rios")
    print("7Ô∏è‚É£  Listar Contas")
    print("8Ô∏è‚É£  Relat√≥rio de Transa√ß√µes")
    print("9Ô∏è‚É£  Sair")
    print("=" * 60)


def filtrar_cliente(cpf: str, clientes: list[PessoaFisica]) -> PessoaFisica | None:
    """Filtra cliente por CPF."""
    cpf_numeros = "".join(filter(str.isdigit, cpf))
    clientes_filtrados = [cliente for cliente in clientes if cliente.cpf == cpf_numeros]
    return clientes_filtrados[0] if clientes_filtrados else None


def recuperar_conta_cliente(cliente: Cliente) -> Conta | None:
    """Recupera conta do cliente."""
    if not cliente.contas:
        print("\n‚ùå Cliente n√£o possui conta!")
        return None

    if len(cliente.contas) == 1:
        return cliente.contas[0]

    # Se cliente tem m√∫ltiplas contas, listar para escolha
    print("\nüè¶ Contas dispon√≠veis:")
    for i, conta in enumerate(cliente.contas, 1):
        print(f"{i}. Conta {conta.numero} - Saldo: {conta.get_saldo_formatado()}")

    try:
        escolha = int(input("Escolha o n√∫mero da conta: ")) - 1
        if 0 <= escolha < len(cliente.contas):
            return cliente.contas[escolha]
        else:
            print("‚ùå Op√ß√£o inv√°lida!")
            return None
    except ValueError:
        print("‚ùå Digite um n√∫mero v√°lido!")
        return None


def processar_deposito(clientes: list[PessoaFisica]) -> None:
    """Fun√ß√£o para realizar dep√≥sito."""
    cpf = input("Informe o CPF do cliente: ")
    cliente = filtrar_cliente(cpf, clientes)

    if not cliente:
        print("\n‚ùå Cliente n√£o encontrado!")
        return

    try:
        valor = float(input("Informe o valor do dep√≥sito: "))
    except ValueError:
        print("‚ùå Valor inv√°lido!")
        return

    conta = recuperar_conta_cliente(cliente)
    if not conta:
        return

    transacao = Deposito(valor)
    cliente.realizar_transacao(conta, transacao)


def processar_saque(clientes: list[PessoaFisica]) -> None:
    """Fun√ß√£o para realizar saque."""
    cpf = input("Informe o CPF do cliente: ")
    cliente = filtrar_cliente(cpf, clientes)

    if not cliente:
        print("\n‚ùå Cliente n√£o encontrado!")
        return

    try:
        valor = float(input("Informe o valor do saque: "))
    except ValueError:
        print("‚ùå Valor inv√°lido!")
        return

    conta = recuperar_conta_cliente(cliente)
    if not conta:
        return

    transacao = Saque(valor)
    cliente.realizar_transacao(conta, transacao)


def exibir_extrato(clientes: list[PessoaFisica]) -> None:
    """Fun√ß√£o para exibir extrato."""
    cpf = input("Informe o CPF do cliente: ")
    cliente = filtrar_cliente(cpf, clientes)

    if not cliente:
        print("\n‚ùå Cliente n√£o encontrado!")
        return

    conta = recuperar_conta_cliente(cliente)
    if not conta:
        return

    print("\n" + "=" * 100)
    print("EXTRATO".center(100))
    print("=" * 100)

    transacoes = conta.historico.gerar_relatorio()
    print(transacoes)

    print(f"\nSaldo:\t\tR$ {conta.saldo:.2f}")
    print("=" * 100)


def processar_criacao_usuario(clientes: list[PessoaFisica]) -> None:
    """Processa cria√ß√£o de novo usu√°rio."""
    print("\nüë§ CRIAR NOVO USU√ÅRIO")
    nome = input("üìù Nome completo: ").strip()
    data_nascimento = input("üìÖ Data de nascimento (DD/MM/AAAA): ").strip()
    cpf = input("üìÑ CPF (apenas n√∫meros): ").strip()

    if not validar_cpf(cpf):
        print("‚ùå Erro: CPF deve ter 11 d√≠gitos!")
        return

    cliente_existente = filtrar_cliente(cpf, clientes)
    if cliente_existente:
        print("‚ùå Erro: J√° existe cliente com esse CPF!")
        return

    print("üè† Endere√ßo:")
    logradouro = input("   Logradouro: ").strip()
    numero = input("   N√∫mero: ").strip()
    bairro = input("   Bairro: ").strip()
    cidade = input("   Cidade: ").strip()
    estado = input("   Estado (sigla): ").strip()

    endereco = f"{logradouro}, {numero} - {bairro} - {cidade}/{estado}"

    if nome and data_nascimento and cpf:
        cliente = PessoaFisica(nome=nome, data_nascimento=data_nascimento, cpf=cpf, endereco=endereco)
        clientes.append(cliente)
        print(f"‚úÖ Usu√°rio {nome} criado com sucesso!")
    else:
        print("‚ùå Erro: Todos os campos s√£o obrigat√≥rios!")


def processar_criacao_conta(clientes: list[PessoaFisica], contas: list[Conta]) -> None:
    """Processa cria√ß√£o de conta corrente."""
    print("\nüè¶ CRIAR CONTA CORRENTE")
    cpf = input("üìÑ CPF do usu√°rio: ").strip()

    if not validar_cpf(cpf):
        print("‚ùå Erro: CPF deve ter 11 d√≠gitos!")
        return

    cliente = filtrar_cliente(cpf, clientes)
    if not cliente:
        print("‚ùå Erro: Cliente n√£o encontrado!")
        return

    numero_conta = len(contas) + 1
    conta = ContaCorrente.nova_conta(cliente=cliente, numero=numero_conta)
    contas.append(conta)
    cliente.adicionar_conta(conta)

    print(f"‚úÖ Conta {conta.numero} criada com sucesso para {cliente.nome}!")
    print(f"üè¶ Ag√™ncia: {conta.agencia} - Conta: {conta.numero}")


def listar_contas(contas: list[Conta]) -> None:
    """Fun√ß√£o para listar todas as contas."""
    if not contas:
        print("\nüìù Nenhuma conta cadastrada.")
        return

    print("\nüè¶ CONTAS CADASTRADAS:")
    print("-" * 100)
    for conta in contas:
        linha = f"Ag√™ncia: {conta.agencia} | Conta: {conta.numero} | "
        if isinstance(conta.cliente, PessoaFisica):
            linha += f"Titular: {conta.cliente.nome} | Saldo: {conta.get_saldo_formatado()}"
        print(linha)


def validar_cpf(cpf: str) -> bool:
    """Valida formato b√°sico do CPF."""
    cpf_numeros = "".join(filter(str.isdigit, cpf))
    return len(cpf_numeros) == 11


def listar_usuarios(clientes: list[PessoaFisica]) -> None:
    """Lista todos os usu√°rios cadastrados."""
    if not clientes:
        print("üìù Nenhum usu√°rio cadastrado no sistema.")
        return

    print("\nüë• USU√ÅRIOS CADASTRADOS:")
    print("-" * 60)
    for cliente in clientes:
        print(f"üë§ {cliente}")


def gerar_relatorio_transacoes(clientes: list[PessoaFisica]) -> None:
    """Gera relat√≥rio detalhado de transa√ß√µes por tipo."""
    cpf = input("Informe o CPF do cliente: ")
    cliente = filtrar_cliente(cpf, clientes)

    if not cliente:
        print("\n‚ùå Cliente n√£o encontrado!")
        return

    conta = recuperar_conta_cliente(cliente)
    if not conta:
        return

    print("\nüìä RELAT√ìRIO DE TRANSA√á√ïES")
    print("=" * 50)

    tipo = input("Tipo de transa√ß√£o (deposito/saque/todas): ").lower()

    if tipo in ["deposito", "saque"]:
        relatorio = conta.historico.gerar_relatorio(tipo)
    else:
        relatorio = conta.historico.gerar_relatorio()

    print(relatorio)

    # Mostra transa√ß√µes do dia
    transacoes_hoje = conta.historico.transacoes_do_dia()
    print(f"\nüìÖ Transa√ß√µes hoje: {len(transacoes_hoje)}")
    print(f"üí∞ Saldo atual: {conta.get_saldo_formatado()}")


def main() -> None:
    """Fun√ß√£o principal do sistema banc√°rio."""
    clientes: list[PessoaFisica] = []
    contas: list[Conta] = []

    print("üè¶ Bem-vindo ao Sistema Banc√°rio v3.0!")
    print("üìù Sistema orientado a objetos com heran√ßa e polimorfismo")

    while True:
        exibir_menu()

        try:
            opcao = input("üîç Escolha uma op√ß√£o: ").strip()

            if opcao == "1":
                processar_criacao_usuario(clientes)

            elif opcao == "2":
                processar_criacao_conta(clientes, contas)

            elif opcao == "3":
                print("\nüí∞ REALIZAR DEP√ìSITO")
                processar_deposito(clientes)

            elif opcao == "4":
                print("\nüí∏ REALIZAR SAQUE")
                processar_saque(clientes)

            elif opcao == "5":
                print("\nüìã VISUALIZAR EXTRATO")
                exibir_extrato(clientes)

            elif opcao == "6":
                listar_usuarios(clientes)

            elif opcao == "7":
                listar_contas(contas)

            elif opcao == "8":
                print("\nüìä RELAT√ìRIO DE TRANSA√á√ïES")
                gerar_relatorio_transacoes(clientes)

            elif opcao == "9":
                print("üëã Obrigado por usar o Sistema Banc√°rio!")
                break

            else:
                print("‚ùå Op√ß√£o inv√°lida! Digite um n√∫mero de 1 a 9.")

        except KeyboardInterrupt:
            print("\n\nüëã Sistema encerrado pelo usu√°rio.")
            break
        except Exception as e:
            print(f"‚ùå Erro inesperado: {e}")


if __name__ == "__main__":
    main()
