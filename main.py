from datetime import datetime


class Usuario:
    """Classe que representa um usu√°rio (cliente) do banco."""

    def __init__(self, nome: str, data_nascimento: str, cpf: str, endereco: str) -> None:
        self.nome: str = nome
        self.data_nascimento: str = data_nascimento
        self.cpf: str = self._formatar_cpf(cpf)
        self.endereco: str = endereco

    def _formatar_cpf(self, cpf: str) -> str:
        """Remove formata√ß√£o do CPF e armazena apenas n√∫meros."""
        return "".join(filter(str.isdigit, cpf))

    def get_cpf_formatado(self) -> str:
        """Retorna CPF formatado para exibi√ß√£o."""
        cpf = self.cpf
        return f"{cpf[:3]}.{cpf[3:6]}.{cpf[6:9]}-{cpf[9:]}"

    def __str__(self) -> str:
        return f"{self.nome} - CPF: {self.get_cpf_formatado()}"


class ContaCorrente:
    """Classe que representa uma conta corrente."""

    _contador_contas: int = 1

    def __init__(self, usuario: Usuario, agencia: str = "0001") -> None:
        self.agencia: str = agencia
        self.numero_conta: int = ContaCorrente._contador_contas
        self.usuario: Usuario = usuario
        self._saldo_centavos: int = 0
        self._historico: list[dict[str, str]] = []
        self._limite_saque_diario_centavos: int = 50000  # R$ 500,00
        self._saques_realizados_hoje: int = 0
        self._limite_saques_diarios: int = 3
        self._data_ultimo_saque: str = ""

        ContaCorrente._contador_contas += 1

    def _real_para_centavos(self, valor: float) -> int:
        """Converte valor em reais para centavos."""
        return round(valor * 100)

    def _centavos_para_real(self, centavos: int) -> str:
        """Converte centavos para formato de reais."""
        reais = centavos // 100
        cents = centavos % 100
        return f"{reais}.{cents:02d}"

    def _formatar_moeda(self, centavos: int) -> str:
        """Formata centavos para exibi√ß√£o em moeda brasileira."""
        return f"R$ {self._centavos_para_real(centavos)}"

    def depositar(self, valor: float) -> bool:
        """
        Realiza dep√≥sito na conta.

        Args:
            valor: Valor a ser depositado em reais (deve ser positivo)

        Returns:
            bool: True se o dep√≥sito foi realizado com sucesso
        """
        if valor <= 0:
            print("‚ùå Erro: O valor do dep√≥sito deve ser positivo!")
            return False

        valor_centavos = self._real_para_centavos(valor)
        self._saldo_centavos += valor_centavos

        # Registra no hist√≥rico
        timestamp = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        self._historico.append(
            {
                "tipo": "DEP√ìSITO",
                "valor": self._formatar_moeda(valor_centavos),
                "data": timestamp,
                "saldo_pos": self._formatar_moeda(self._saldo_centavos),
            }
        )

        print("‚úÖ Dep√≥sito realizado com sucesso!")
        print(f"üí∞ Valor depositado: {self._formatar_moeda(valor_centavos)}")
        print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
        return True

    def sacar(self, valor: float) -> bool:
        """
        Realiza saque da conta com valida√ß√µes de limite e saldo.

        Args:
            valor: Valor a ser sacado em reais

        Returns:
            bool: True se o saque foi realizado com sucesso
        """
        if valor <= 0:
            print("‚ùå Erro: O valor do saque deve ser positivo!")
            return False

        valor_centavos = self._real_para_centavos(valor)
        data_hoje = datetime.now().strftime("%d/%m/%Y")

        # Reset contador se mudou o dia
        if self._data_ultimo_saque != data_hoje:
            self._saques_realizados_hoje = 0
            self._data_ultimo_saque = data_hoje

        # Valida√ß√£o de limite de saques di√°rios
        if self._saques_realizados_hoje >= self._limite_saques_diarios:
            print(f"‚ùå Erro: Limite de {self._limite_saques_diarios} saques di√°rios atingido!")
            return False

        # Valida√ß√£o de limite por saque
        if valor_centavos > self._limite_saque_diario_centavos:
            print(
                f"‚ùå Erro: Valor excede o limite m√°ximo de {self._formatar_moeda(self._limite_saque_diario_centavos)}",
                " por saque!",
            )
            return False

        # Valida√ß√£o de saldo
        if valor_centavos > self._saldo_centavos:
            print("‚ùå Erro: Saldo insuficiente para realizar o saque!")
            print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
            return False

        # Realiza o saque
        self._saldo_centavos -= valor_centavos
        self._saques_realizados_hoje += 1

        # Registra no hist√≥rico
        timestamp = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        self._historico.append(
            {
                "tipo": "SAQUE",
                "valor": self._formatar_moeda(valor_centavos),
                "data": timestamp,
                "saldo_pos": self._formatar_moeda(self._saldo_centavos),
            }
        )

        print("‚úÖ Saque realizado com sucesso!")
        print(f"üí∏ Valor sacado: {self._formatar_moeda(valor_centavos)}")
        print(f"üí≥ Saldo atual: {self._formatar_moeda(self._saldo_centavos)}")
        print(f"üìä Saques restantes hoje: {self._limite_saques_diarios - self._saques_realizados_hoje}")
        return True

    def visualizar_extrato(self) -> None:
        """Exibe o extrato completo da conta com todas as opera√ß√µes."""
        print("\n" + "=" * 70)
        print("üìã EXTRATO BANC√ÅRIO")
        print("=" * 70)
        print(f"üë§ Titular: {self.usuario.nome}")
        print(f"üìÑ CPF: {self.usuario.get_cpf_formatado()}")
        print(f"üè¶ Ag√™ncia: {self.agencia}")
        print(f"üî¢ Conta: {self.numero_conta}")
        print(f"üìÖ Data: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
        print("-" * 70)

        if not self._historico:
            print("üìù Nenhuma movimenta√ß√£o registrada.")
        else:
            print("üìä MOVIMENTA√á√ïES:")
            print("-" * 70)
            for operacao in self._historico:
                tipo_icon = "üìà" if operacao["tipo"] == "DEP√ìSITO" else "üìâ"
                print(f"{tipo_icon} {operacao['tipo']}")
                print(f"   üí∞ Valor: {operacao['valor']}")
                print(f"   üìÖ Data: {operacao['data']}")
                print(f"   üí≥ Saldo: {operacao['saldo_pos']}")
                print("-" * 35)

        print(f"üí∞ SALDO ATUAL: {self._formatar_moeda(self._saldo_centavos)}")
        print("=" * 70)

    def get_saldo_formatado(self) -> str:
        """Retorna o saldo atual formatado."""
        return self._formatar_moeda(self._saldo_centavos)

    def get_info(self) -> dict[str, str]:
        """Retorna informa√ß√µes b√°sicas da conta."""
        return {
            "titular": self.usuario.nome,
            "cpf": self.usuario.get_cpf_formatado(),
            "agencia": self.agencia,
            "conta": str(self.numero_conta),
            "saldo": self._formatar_moeda(self._saldo_centavos),
        }


class SistemaBancario:
    """Sistema banc√°rio principal que gerencia usu√°rios e contas."""

    def __init__(self) -> None:
        self._usuarios: list[Usuario] = []
        self._contas: list[ContaCorrente] = []
        self._conta_atual: ContaCorrente | None = None

    def criar_usuario(self, nome: str, data_nascimento: str, cpf: str, endereco: str) -> bool:
        """
        Cria um novo usu√°rio.

        Args:
            nome: Nome completo do usu√°rio
            data_nascimento: Data no formato DD/MM/AAAA
            cpf: CPF do usu√°rio (apenas n√∫meros)
            endereco: Endere√ßo no formato: logradouro, nro - bairro - cidade/sigla estado

        Returns:
            bool: True se o usu√°rio foi criado com sucesso
        """
        # Remove formata√ß√£o do CPF para verifica√ß√£o
        cpf_numeros = "".join(filter(str.isdigit, cpf))

        # Verifica se CPF j√° existe
        if self._buscar_usuario_por_cpf(cpf_numeros):
            print(f"‚ùå Erro: Usu√°rio com CPF {cpf} j√° existe!")
            return False

        usuario = Usuario(nome, data_nascimento, cpf_numeros, endereco)
        self._usuarios.append(usuario)
        print(f"‚úÖ Usu√°rio {nome} criado com sucesso!")
        return True

    def _buscar_usuario_por_cpf(self, cpf: str) -> Usuario | None:
        """Busca usu√°rio pelo CPF."""
        cpf_numeros = "".join(filter(str.isdigit, cpf))
        for usuario in self._usuarios:
            if usuario.cpf == cpf_numeros:
                return usuario
        return None

    def criar_conta_corrente(self, cpf: str) -> bool:
        """
        Cria uma conta corrente vinculada a um usu√°rio.

        Args:
            cpf: CPF do usu√°rio para vincular a conta

        Returns:
            bool: True se a conta foi criada com sucesso
        """
        usuario = self._buscar_usuario_por_cpf(cpf)
        if not usuario:
            print(f"‚ùå Erro: Usu√°rio com CPF {cpf} n√£o encontrado!")
            return False

        conta = ContaCorrente(usuario)
        self._contas.append(conta)
        print(f"‚úÖ Conta {conta.numero_conta} criada com sucesso para {usuario.nome}!")
        print(f"üè¶ Ag√™ncia: {conta.agencia} - Conta: {conta.numero_conta}")
        return True

    def selecionar_conta(self, agencia: str, numero_conta: int) -> bool:
        """
        Seleciona uma conta para opera√ß√µes.

        Args:
            agencia: N√∫mero da ag√™ncia
            numero_conta: N√∫mero da conta

        Returns:
            bool: True se a conta foi selecionada com sucesso
        """
        for conta in self._contas:
            if conta.agencia == agencia and conta.numero_conta == numero_conta:
                self._conta_atual = conta
                info = conta.get_info()
                print(f"‚úÖ Conta selecionada: {info['agencia']}-{info['conta']} - {info['titular']}")
                return True

        print(f"‚ùå Erro: Conta {agencia}-{numero_conta} n√£o encontrada!")
        return False

    def get_conta_atual(self) -> ContaCorrente | None:
        """Retorna a conta atualmente selecionada."""
        return self._conta_atual

    def listar_usuarios(self) -> None:
        """Lista todos os usu√°rios cadastrados."""
        if not self._usuarios:
            print("üìù Nenhum usu√°rio cadastrado no sistema.")
            return

        print("\nüë• USU√ÅRIOS CADASTRADOS:")
        print("-" * 60)
        for usuario in self._usuarios:
            print(f"üë§ {usuario}")

    def listar_contas(self) -> None:
        """Lista todas as contas do sistema."""
        if not self._contas:
            print("üìù Nenhuma conta cadastrada no sistema.")
            return

        print("\nüè¶ CONTAS CADASTRADAS:")
        print("-" * 80)
        for conta in self._contas:
            info = conta.get_info()
            print(f"üè¶ {info['agencia']}-{info['conta']} | {info['titular']} | {info['cpf']} | {info['saldo']}")


# Fun√ß√µes para opera√ß√µes banc√°rias (vers√£o modularizada)
def depositar(conta: ContaCorrente, valor: float) -> bool:
    """Fun√ß√£o para realizar dep√≥sito."""
    return conta.depositar(valor)


def sacar(conta: ContaCorrente, valor: float) -> bool:
    """Fun√ß√£o para realizar saque."""
    return conta.sacar(valor)


def visualizar_historico(conta: ContaCorrente) -> None:
    """Fun√ß√£o para visualizar o hist√≥rico/extrato."""
    conta.visualizar_extrato()


# Fun√ß√µes utilit√°rias
def exibir_menu() -> None:
    """Exibe o menu principal do sistema."""
    print("\n" + "=" * 60)
    print("üè¶ SISTEMA BANC√ÅRIO - VERS√ÉO 2.0")
    print("=" * 60)
    print("1Ô∏è‚É£  Criar Usu√°rio")
    print("2Ô∏è‚É£  Criar Conta Corrente")
    print("3Ô∏è‚É£  Selecionar Conta")
    print("4Ô∏è‚É£  Depositar")
    print("5Ô∏è‚É£  Sacar")
    print("6Ô∏è‚É£  Visualizar Extrato")
    print("7Ô∏è‚É£  Listar Usu√°rios")
    print("8Ô∏è‚É£  Listar Contas")
    print("9Ô∏è‚É£  Sair")
    print("=" * 60)


def obter_valor_monetario(prompt: str) -> float | None:
    """Obt√©m um valor monet√°rio v√°lido do usu√°rio."""
    try:
        valor_str = input(prompt).replace(",", ".")
        valor = float(valor_str)
        if valor <= 0:
            print("‚ùå Erro: O valor deve ser positivo!")
            return None
        return valor
    except ValueError:
        print("‚ùå Erro: Valor inv√°lido! Digite um n√∫mero v√°lido.")
        return None


def validar_cpf(cpf: str) -> bool:
    """Valida formato b√°sico do CPF."""
    cpf_numeros = "".join(filter(str.isdigit, cpf))
    return len(cpf_numeros) == 11


def main() -> None:  # noqa: C901
    """Fun√ß√£o principal do sistema banc√°rio."""
    sistema = SistemaBancario()

    print("üè¶ Bem-vindo ao Sistema Banc√°rio v2.0!")
    print("üìù Sistema modularizado com usu√°rios e contas correntes")

    while True:
        exibir_menu()

        try:
            opcao = input("üîç Escolha uma op√ß√£o: ").strip()

            if opcao == "1":
                print("\nüë§ CRIAR NOVO USU√ÅRIO")
                nome = input("üìù Nome completo: ").strip()
                data_nascimento = input("üìÖ Data de nascimento (DD/MM/AAAA): ").strip()
                cpf = input("üìÑ CPF (apenas n√∫meros): ").strip()

                if not validar_cpf(cpf):
                    print("‚ùå Erro: CPF deve ter 11 d√≠gitos!")
                    continue

                print("üè† Endere√ßo:")
                logradouro = input("   Logradouro: ").strip()
                numero = input("   N√∫mero: ").strip()
                bairro = input("   Bairro: ").strip()
                cidade = input("   Cidade: ").strip()
                estado = input("   Estado (sigla): ").strip()

                endereco = f"{logradouro}, {numero} - {bairro} - {cidade}/{estado}"

                if nome and data_nascimento and cpf:
                    sistema.criar_usuario(nome, data_nascimento, cpf, endereco)
                else:
                    print("‚ùå Erro: Todos os campos s√£o obrigat√≥rios!")

            elif opcao == "2":
                print("\nüè¶ CRIAR CONTA CORRENTE")
                cpf = input("üìÑ CPF do usu√°rio: ").strip()

                if not validar_cpf(cpf):
                    print("‚ùå Erro: CPF deve ter 11 d√≠gitos!")
                    continue

                sistema.criar_conta_corrente(cpf)

            elif opcao == "3":
                print("\nüîç SELECIONAR CONTA")
                sistema.listar_contas()
                agencia = input("üè¶ Digite o n√∫mero da ag√™ncia: ").strip()
                try:
                    numero_conta = int(input("üî¢ Digite o n√∫mero da conta: ").strip())
                    sistema.selecionar_conta(agencia, numero_conta)
                except ValueError:
                    print("‚ùå Erro: N√∫mero da conta deve ser um n√∫mero!")

            elif opcao == "4":
                conta_atual = sistema.get_conta_atual()
                if not conta_atual:
                    print("‚ùå Erro: Nenhuma conta selecionada! Selecione uma conta primeiro.")
                    continue

                print(f"\nüí∞ DEP√ìSITO - Conta: {conta_atual.agencia}-{conta_atual.numero_conta}")
                valor = obter_valor_monetario("üíµ Digite o valor para dep√≥sito (R$): ")
                if valor is not None:
                    depositar(conta_atual, valor)

            elif opcao == "5":
                conta_atual = sistema.get_conta_atual()
                if not conta_atual:
                    print("‚ùå Erro: Nenhuma conta selecionada! Selecione uma conta primeiro.")
                    continue

                print(f"\nüí∏ SAQUE - Conta: {conta_atual.agencia}-{conta_atual.numero_conta}")
                print(f"üí≥ Saldo atual: {conta_atual.get_saldo_formatado()}")
                valor = obter_valor_monetario("üíµ Digite o valor para saque (R$): ")
                if valor is not None:
                    sacar(conta_atual, valor)

            elif opcao == "6":
                conta_atual = sistema.get_conta_atual()
                if not conta_atual:
                    print("‚ùå Erro: Nenhuma conta selecionada! Selecione uma conta primeiro.")
                    continue

                visualizar_historico(conta_atual)

            elif opcao == "7":
                sistema.listar_usuarios()

            elif opcao == "8":
                sistema.listar_contas()

            elif opcao == "9":
                print("üëã Obrigado por usar o Sistema Banc√°rio!")
                break

            else:
                print("‚ùå Op√ß√£o inv√°lida! Digite um n√∫mero de 1 a 9.")

        except KeyboardInterrupt:
            print("\n\nüëã Sistema encerrado pelo usu√°rio.")
            break
        except Exception as e:
            print(f"‚ùå Erro inesperado: {e}")


if __name__ == "__main__":
    main()
